<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University of Poppleton chat system </title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7fa;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
        }
        #chat-container {
            background-color: white;
            width: 400px; /* Limit width */
            height: 500px; /* Limit height */
            display: flex;
            flex-direction: column;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        #chat-header {
            background-color: #6200ea;
            border-radius: 5px;
            color: white;
            padding: 15px;
            font-size: 1.2rem;
            text-align: center;
            display: flex; /* Enables side-by-side layout */
            justify-content: space-between; /* Space between header title and buttons */
            align-items: center; /* Vertically centers items */

        }
        #chat-box {
            scroll-behavior: smooth;
            padding: 10px;
            overflow-y: auto;
            border-bottom: 1px solid #ddd;
            position: absolute;
            top: 90px; /* Adjust this value based on the height of the header */
            bottom: 60px; /* Adjust this value based on the height of the input container */
            width: calc(100% - 20px);
        }
        #input-container {
            display: flex;
            padding: 10px;
            background-color: #f1f1f1;
            border-top: 1px solid #ccc;
            position: absolute; /* Position absolute to stay at the bottom */
            bottom: 0; /* Align to the bottom of the chat container */
            width: 100%;
        }
        #message-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-right: 10px;
            
        }
        #send-button {
            padding: 10px 15px;
            background-color: #6d0ef1;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            
        }
        #send-button:hover {
            background-color: #0056b3;
        }
        #history-box {
            display: none;
            position: absolute;
            top: 50px;
            width: 100%;
            height: calc(100% - 100px);
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow-y: auto;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            padding: 5px;
        }
        .history-content {
            padding: 10px;
            margin-top: 10px;
            overflow-y: auto;
            max-height: calc(100% - 50px); /* Ensures the content fits well within the box */
        }

        .history-header button {
            background-color: #007bff; /* Blue button for actions */
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .history-header button:hover {
            background-color: #0056b3; /* Darker blue on hover */
        }

        #name-container {
            margin: 20px;
            text-align: center;
        }
        #name-container input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 80%;
            font-size: 16px;
        }

        #name-container button {
            padding: 10px 15px;
            background-color: #6200ea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        #name-container button:hover {
            background-color: #3700b3;
        }

        .message {
            margin-bottom: 15px;
        }
        .message.agent {
            text-align: left;
        }
        .message.user {
            text-align: right;
        }

        /* Loading Spinner */
        #loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        #loading-spinner div {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6200ea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            #chat-container {
                width: 100%;
                height: 400px;
            }
        
            #chat-box {
                height: 300px;
            }
        
            #input-container {
                flex-direction: column;
                gap: 10px;
            }
        
            #message-input,
            #send-button {
                width: 100%;
            }
        }


    </style>
    <script>
        let userName = "";
        let messages = [];
        let chatSession = null; // Store chat session
    
        // Restore chat session if exists (for refresh)
        window.onload = function () {
            const storedSession = localStorage.getItem('chatSession');
            const historyButton = document.getElementById('history-button');
            const chatBox = document.getElementById('chat-box')
            
            // Reset chatbox content
            chatBox.innerHTML = ""; // Clear chatbox to ensure no residual messages are shown

            // Reset messages array
            // messages = [];
            userName = localStorage.getItem("userName");
           
            if (storedSession && userName) {
                // Display the "View History" button if there's a previous session
                historyButton.style.display = 'block';
                fetchChatHistory();
            } else {
                // Hide the "View History" button if there's no session
                historyButton.style.display = "none";
            }
        };

        // Show loading spinner
        function showSpinner() {
            document.getElementById('loading-spinner').style.display = 'block';
        }

        // Hide loading spinner
        function hideSpinner() {
            document.getElementById('loading-spinner').style.display = 'none';
        }

        // Helper function to render messages
        function renderMessages(messages) {
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = messages
                .map(msg => {
                    const [sender, message] = Object.entries(msg)[0];
                    const msgClass = sender === userName ? 'user' : 'agent';
                    const formattedMessage = message.replace("{user_name}", userName);
                    return `<div class="message ${msgClass}"><b>${sender}:</b> ${formattedMessage}</div>`;
                })
                .join('');
            setTimeout(() => {
                chatBox.scrollTop = chatBox.scrollHeight;
            }, 100);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const sendButton = document.getElementById('send-button');
            console.log(sendButton);  // Check if the button is found
            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            } else {
                console.error("Button with ID 'send-button' not found.");
            }

            const startChatButton = document.querySelector('button[onclick="startChat()"]');
            if (startChatButton) {
                // Remove existing listeners to prevent duplicates
                startChatButton.replaceWith(startChatButton.cloneNode(true));
                startChatButton.addEventListener('click', startChat);
            } else {
                console.error("Start Chat button not found.");
            }
        });
    
        
        async function sendMessage() {
            console.log("Sending message..."); // Debugging line
            const message = document.getElementById('message').value;
    
            if (!message.trim()) {
                alert("Please enter a message before sending!");
                return;
            }

            const userMessage = { [userName]: message };
            chatSession.messages.push(userMessage);
            renderMessages(chatSession.messages);
    
            const sendButton = document.getElementById('send-button');
            sendButton.disabled = true; // Disable send button during processing
            showSpinner();

            try {
                const response = await fetch('/chat/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_name: userName, message })
                });
    
                const data = await response.json();
    
                if (response.status !== 200) {
                    alert(data.error || "An error occurred. Please try again.");
                    return;
                }
                
            
                // Check if the chat session has ended
                if (data.end_chat) {
                    renderMessages(data.messages)
                    // Disable the message input and send button
                    document.getElementById('message').disabled = true;
                    document.getElementById('send-button').disabled = true;
                    setTimeout(() => {
                        alert("The chat session has ended. Refresh the page to start a new chat.");
                        localStorage.removeItem('chatSession'); // Clear session on end
                        
                    },500);
                    return;
                  
                }
                
                // Update chat session with the latest server response
                chatSession.messages = data.messages;
                renderMessages(chatSession.messages);

                const chatBox = document.getElementById('chat-box');
                chatBox.scrollTop = chatBox.scrollHeight;

                // Clear the message input
                document.getElementById('message').value = '';

                // Store session for restoration
                localStorage.setItem('chatSession', JSON.stringify(data));
                
            } catch (error) {
                alert("An error occurred while sending the message. Please try again.");
                console.error(error);
            } finally {
                sendButton.disabled = false; // Re-enable send button
                hideSpinner();
            }
        }
                
        async function startChat() {
            console.log("Start Chat button clicked!");
            const userNameInput = document.getElementById("name-input");
            userName = userNameInput.value.trim();

            if (!userName) {
                alert("Please enter your name to start the chat.");
                return;
            }
            localStorage.setItem("userName", userName);

            messages = [];
            chatSession = null;
              
            // Disable the Start Chat button
            document.querySelector('button[onclick="startChat()"]').disabled = true;

            document.getElementById("name-container").style.display = 'none';
            document.getElementById("chat-container").style.display = 'block';

            document.getElementById("chat-box").innerHTML = '';

            try{
                const response = await fetch('/chat/', {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        user_name: userName,
                        message: "", // Starting the chat with no message
                    }),
                });
                const data = await response.json();
            
                if (!response.ok) {
                    throw new Error("Failed to start chat. Please try again.");
                }
                 
                if (data.error) {
                    alert(data.error);
                    return;
                }else{
                    chatSession = {
                        user_name: userName,
                        messages: data.messages || [],
                    };
                
                    localStorage.setItem('chatSession', JSON.stringify(chatSession));
                
                    renderMessages(chatSession.messages);
                }
                
                document.getElementById('history-button').style.display = 'block'; // Show history button after starting
            } catch (error) {
                console.error("Error:", error);
                alert(error.message);
            }
        }

        async function toggleHistory() {
            const historyBox = document.getElementById('history-box');
            if (historyBox.style.display === "none" || !historyBox.style.display) {
                await fetchChatHistory();
            } else {
                closeHistory();
            }
        }

        async function fetchChatHistory() {
            const userName = localStorage.getItem("userName");
            if (!userName) {
                alert("User not identified. Please refresh the page and start the chat.");
                return;
            }
            try{
                const response = await fetch(`/get_chat_history/${userName}`);
                if (!response.ok) throw new Error("Failed to fetch chat history.");

                const history = await response.json();
                const historyBox = document.getElementById('history-box');
                let historyContent = "";

                if (Array.isArray(history) && history.length > 0) {
                    historyContent = history.map(item =>{
                        if (item.agent_name) {
                            return `<div><p><b>${item.agent_name}:</b> ${item.message}</p></div>`;
                        } else if (item.user_name) {
                            return `<div><p><b>${item.user_name}:</b> ${item.message}</p></div>`;
                        }
                        return ""; 
                    }).join('');
                } else {
                    historyContent = "No chat history available.";
                }
                historyBox.innerHTML = `
                    <div class="history-header">
                        <h4>Your Chat History</h4>
                        <button id="delete-history-button" onclick="deleteHistory()">Delete</button>
                        <button onclick="closeHistory()">Close</button>
                    </div>
                    <div class="history-content">${historyContent}</div>`;

                historyBox.style.display = 'block';
            } catch (error) {
                console.error(error);
                alert("An error occurred while fetching chat history.");
            }
        }

        // Close the history box
        function closeHistory() {
            const historyBox = document.getElementById('history-box');
            historyBox.style.display = 'none';
        }

        // Delete the user's chat history
        async function deleteHistory() {
            const userName = localStorage.getItem('userName');
            if (!userName) {
                alert("User not identified. Please refresh the page and start the chat.");
                return;
            }
        
            if (confirm("Are you sure you want to delete your chat history?")) {
                try {
                    // Send a DELETE request to the backend
                    const response = await fetch(`/delete_chat_history/${userName}/`, { 
                        method: 'DELETE',
                        headers: {
                            "Content-Type": "application/json"
                        },
                    });


                    const contentType = response.headers.get("Content-Type");
                    if (!contentType || !contentType.includes("application/json")) {
                        throw new Error("Expected JSON response, but got something else.");
                    }

                    const responseBody = await response.json();
                    if (responseBody.message) {
                        alert(responseBody.message);  // Show success message
                    }

                    if (response.status === 404) {
                        alert("No chat history found for the user.");
                        return;
                    }

                    if (!response.ok) {
                        throw new Error("Failed to delete chat history.");
                    }

                    chatSession = null;
                    localStorage.removeItem('chatSession');

                    // Clear chatbox and reset UI
                    document.getElementById('chat-box').innerHTML = '';
                    document.getElementById('history-box').innerHTML = '';
                    document.getElementById('history-box').style.display = 'none';
                    document.getElementById("message").value = '';
                    document.getElementById("message").disabled = false;
                    document.getElementById("send-button").disabled = false;

                    alert("Your chat session has been reset. Refresh the page to start a new chat.");
                    
                } catch (error) {
                    console.error(error);
                    alert("An error occurred: " + error.message);
                }
            }
        }

    </script>    
</head>
<body>
    <div id="name-container">
        <h2>Welcome! to Poppleton University Chat Assist</h2>
        <input type="text" id="name-input" placeholder="Your Name" />
        <button onclick="startChat()">Start Chat</button>
    </div>

    <div id="chat-container" style="display: none;">
        <div id="chat-header">
            <h3>Chat Assistant</h3>
            <button id="history-button" onclick="toggleHistory()"style="display:none">View History</button>
        </div>
        <div id="chat-box"></div>
        <div id="input-container">
            <input type="text" id="message" placeholder="Type your message here..." />
            <button id="send-button">Send</button>
        </div>
    </div>
    <!-- History Box (Hidden by default) -->
    <div id="history-box" style="display: none;"></div>

    <!-- Loading Spinner -->
    <div id="loading-spinner">
        <div></div>
    </div>
</body>
</html>